<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.roommake.user.mapper.UserMapper">

    <resultMap type="com.roommake.user.vo.User" id="UserResultMap">
        <id column="user_id" property="id"/>
        <result column="user_email" property="email"/>
        <result column="user_password" property="password"/>
        <result column="user_nickname" property="nickname"/>
        <result column="user_profile_photo" property="profilePhoto"/>
        <result column="user_tel" property="tel"/>
        <result column="user_birth_date" property="birthDate"/>
        <result column="user_introduction" property="introduction"/>
        <result column="user_sns" property="sns"/>
        <result column="user_create_date" property="createDate"/>
        <result column="user_update_date" property="updateDate"/>
        <result column="user_delete_date" property="deleteDate"/>
        <result column="user_unique_recommend_code" property="uniqueRecommendCode"/>
        <result column="user_social_yn" property="socialYn"/>
        <result column="user_status" property="status"/>
        <result column="user_point" property="point"/>
        <result column="user_address" property="address"/>
        <result column="user_complaint_count" property="complaintCount"/>
        <result column="following_count" property="followingCount"/>
        <result column="follower_count" property="followerCount"/>
        <result column="user_option_recommend_code" property="optionRecommendCode"/>
        <association property="gradeId" javaType="com.roommake.user.vo.UserGrade">
            <id column="user_grade_id" property="id"/>
            <id column="user_grade_name" property="name"/>
        </association>
    </resultMap>

    <!-- 모든 유저 조회 -->
    <select id="getAllUsers" resultMap="UserResultMap">
        SELECT *
        FROM user
    </select>


    <!-- 이메일로 유저 조회 -->
    <select id="getUserByEmail" resultMap="UserResultMap">
        SELECT *
        FROM user
        WHERE user_email = #{email}
    </select>

    <!-- 이메일로 사용자 및 권한 조회 -->
    <select id="getUserByEmailWithRoles" resultType="map">
        SELECT u.user_id, u.user_email, u.user_password, u.user_nickname, GROUP_CONCAT(ur.user_role_name) AS roles
        FROM user u
                 JOIN user_role ur ON u.user_id = ur.user_id
        WHERE u.user_email = #{email}
        GROUP BY u.user_id, u.user_email, u.user_password, u.user_nickname
    </select>

    <!-- 닉네임으로 유저 조회 -->
    <select id="getUserByNickname" resultMap="UserResultMap">
        SELECT *
        FROM user
        WHERE user_nickname = #{nickname}
    </select>

    <!-- 추천인 코드 중복 체크 -->
    <select id="existRecommendCode" resultType="boolean">
        SELECT EXISTS(SELECT 1
                      FROM user
                      WHERE user_unique_recommend_code = #{uniqueRecommendCode})
    </select>

    <!-- 유저 등록 -->
    <insert id="createUser" parameterType="com.roommake.user.vo.User">
        <selectKey keyProperty="id" order="AFTER" resultType="int">
            SELECT LAST_INSERT_ID() AS no
        </selectKey>
        INSERT INTO user (user_email, user_password, user_nickname, user_unique_recommend_code)
        VALUES (#{email}, #{password}, #{nickname}, #{uniqueRecommendCode})
    </insert>

    <!-- 페이징 정렬 검색 등 조건 들어간 유저 목록 조회 -->
    <select id="getUsers" parameterType="com.roommake.dto.Criteria" resultMap="UserResultMap">
        select
            *
        from
        (select
            u.user_id,
            u.user_email,
            u.user_nickname,
            u.user_grade_id,
            g.user_grade_name,
            u.user_status,
            u.user_point,
            u.user_create_date,
            u.user_update_date,
            @rownum := @rownum + 1 as row_num
        from
            (select @rownum := 0) r,
            user u
            left join user_grade g on u.user_grade_id = g.user_grade_id
        <where>
            <if test="'email' == opt">
                and u.user_email like CONCAT('%', #{keyword}, '%')
            </if>
            <if test="'nickname' == opt">
                and u.user_nickname like CONCAT('%', #{keyword}, '%')
            </if>
            <choose>
                <when test='filt == "active"'>
                    and u.user_status = 'active'
                </when>
                <when test='filt == "block"'>
                    and u.user_status = 'block'
                </when>
                <when test='filt == "delete"'>
                    and u.user_status = 'delete'
                </when>
            </choose>
                and (u.user_status in('active', 'block', 'delete'))
        </where>
        order by
        <choose>
            <when test="sort == 'date'">
                u.user_id desc
            </when>
            <when test="sort == 'nickname'">
                u.user_nickname asc
            </when>
            <when test="sort == 'grade'">
                u.user_grade_id desc
            </when>
        </choose>
        ) as user
        where
            row_num between #{begin} and #{end}
    </select>

    <!-- 조건에 맞는 유저 전체 수 조회 -->
    <select id="getTotalRows" parameterType="com.roommake.dto.Criteria" resultType="int">
        select count(*)
        from
            user
        <where>
            <if test="'email' == opt">
                and user_email like CONCAT('%', #{keyword}, '%')
            </if>
            <if test="'grade' == opt">
                and user_grade_id = #{keyword}
            </if>
            <if test='filt == "active"'>
                and user_status = 'active'
            </if>
            <if test='filt == "block"'>
                and user_status = 'block'
            </if>
            <if test='filt == "delete"'>
                and user_status = 'delete'
            </if>
                and (user_status in('active', 'block', 'delete'))
        </where>
    </select>
</mapper>
